"""Test .dist-info style distributions.
"""
import os
import shutil
import tempfile
<<<<<<< HEAD

import pytest

import pkg_resources
from .textwrap import DALS


class TestDistInfo:

    def test_distinfo(self):
        dists = dict(
            (d.project_name, d)
            for d in pkg_resources.find_distributions(self.tmpdir)
        )
=======
import unittest
import textwrap

try:
    import ast
except:
    pass

import pkg_resources

from setuptools.tests.py26compat import skipIf

def DALS(s):
    "dedent and left-strip"
    return textwrap.dedent(s).lstrip()

class TestDistInfo(unittest.TestCase):

    def test_distinfo(self):
        dists = {}
        for d in pkg_resources.find_distributions(self.tmpdir):
            dists[d.project_name] = d
>>>>>>> e4baf504ede925f4f1e07d823c9b20b3d0dbe14c

        assert len(dists) == 2, dists

        unversioned = dists['UnversionedDistribution']
        versioned = dists['VersionedDistribution']

        assert versioned.version == '2.718' # from filename
        assert unversioned.version == '0.3' # from METADATA

<<<<<<< HEAD
    @pytest.mark.importorskip('ast')
    def test_conditional_dependencies(self):
        specs = 'splort==4', 'quux>=1.1'
        requires = list(map(pkg_resources.Requirement.parse, specs))

        for d in pkg_resources.find_distributions(self.tmpdir):
            assert d.requires() == requires[:1]
            assert d.requires(extras=('baz',)) == requires
            assert d.extras == ['baz']

    metadata_template = DALS("""
        Metadata-Version: 1.2
        Name: {name}
        {version}
        Requires-Dist: splort (==4)
        Provides-Extra: baz
        Requires-Dist: quux (>=1.1); extra == 'baz'
        """)

    def setup_method(self, method):
        self.tmpdir = tempfile.mkdtemp()
        dist_info_name = 'VersionedDistribution-2.718.dist-info'
        versioned = os.path.join(self.tmpdir, dist_info_name)
        os.mkdir(versioned)
        with open(os.path.join(versioned, 'METADATA'), 'w+') as metadata_file:
            metadata = self.metadata_template.format(
                name='VersionedDistribution',
                version='',
            ).replace('\n\n', '\n')
            metadata_file.write(metadata)
        dist_info_name = 'UnversionedDistribution.dist-info'
        unversioned = os.path.join(self.tmpdir, dist_info_name)
        os.mkdir(unversioned)
        with open(os.path.join(unversioned, 'METADATA'), 'w+') as metadata_file:
            metadata = self.metadata_template.format(
                name='UnversionedDistribution',
                version='Version: 0.3',
            )
            metadata_file.write(metadata)

    def teardown_method(self, method):
=======
    @skipIf('ast' not in globals(),
        "ast is used to test conditional dependencies (Python >= 2.6)")
    def test_conditional_dependencies(self):
        requires = [pkg_resources.Requirement.parse('splort==4'),
                    pkg_resources.Requirement.parse('quux>=1.1')]

        for d in pkg_resources.find_distributions(self.tmpdir):
            self.assertEqual(d.requires(), requires[:1])
            self.assertEqual(d.requires(extras=('baz',)), requires)
            self.assertEqual(d.extras, ['baz'])

    def setUp(self):
        self.tmpdir = tempfile.mkdtemp()
        versioned = os.path.join(self.tmpdir,
                                 'VersionedDistribution-2.718.dist-info')
        os.mkdir(versioned)
        metadata_file = open(os.path.join(versioned, 'METADATA'), 'w+')
        try:
            metadata_file.write(DALS(
                """
                Metadata-Version: 1.2
                Name: VersionedDistribution
                Requires-Dist: splort (4)
                Provides-Extra: baz
                Requires-Dist: quux (>=1.1); extra == 'baz'
                """))
        finally:
            metadata_file.close()
        unversioned = os.path.join(self.tmpdir,
                                   'UnversionedDistribution.dist-info')
        os.mkdir(unversioned)
        metadata_file = open(os.path.join(unversioned, 'METADATA'), 'w+')
        try:
            metadata_file.write(DALS(
                """
                Metadata-Version: 1.2
                Name: UnversionedDistribution
                Version: 0.3
                Requires-Dist: splort (==4)
                Provides-Extra: baz
                Requires-Dist: quux (>=1.1); extra == 'baz'
                """))
        finally:
            metadata_file.close()

    def tearDown(self):
>>>>>>> e4baf504ede925f4f1e07d823c9b20b3d0dbe14c
        shutil.rmtree(self.tmpdir)
